<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Browse • Archaeology Records</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <!-- Header -->
  <header class="site-header">
    <a class="brand" href="./">
      <img class="brand-mark" src="ThunderBunnies.jpg" alt="ThunderBunnies logo" />
      <span class="brand-title">Archaeology Records</span>
    </a>
  </header>

  <!-- Main content -->
  <main class="container">
    <h1>Browse Existing Records</h1>
    <p>Explore archaeological records shared by the Thunder Bunnies community.</p>

    <!-- Controls -->
    <div class="browse-controls">
      <input type="text" id="search" placeholder="Search by title or description...">
      <select id="filter">
        <option value="">All Categories</option>
      </select>
      <button class="btn" id="applyFilter">Filter</button>
      <button class="btn" id="refresh">Refresh</button>
    </div>

    <!-- Records table -->
    <table class="records-table">
      <thead>
        <tr>
          <th>Title</th>
          <th>Description</th>
          <th>Date</th>
          <th>Category</th>
          <th>File</th>
        </tr>
      </thead>
      <tbody id="record-body">
        <tr><td colspan="5">Loading…</td></tr>
      </tbody>
    </table>

    <p id="count" style="color:#555;"></p>

    <!-- Back button -->
    <div class="actions">
      <a class="btn" href="./index.html">⬅ Back to Main Page</a>
    </div>
  </main>

  <!-- Footer -->
  <footer class="container">
    <hr />
    <p>© <span id="year"></span> Thunder Bunnies • Archaeology Records</p>
  </footer>

  <script>
  document.getElementById('year').textContent = new Date().getFullYear();

  // Controls
  const search = document.getElementById('search');
  const filterEl = document.getElementById('filter');
  const applyBtn = document.getElementById('applyFilter');
  const refreshBtn = document.getElementById('refresh') || (function(){
    const b = document.createElement('button');
    b.className = 'btn';
    b.id = 'refresh';
    b.textContent = 'Refresh';
    document.querySelector('.browse-controls').appendChild(b);
    return b;
  })();

  // Add a "Clear local additions" button
  (function ensureClearButton(){
    const container = document.querySelector('.browse-controls');
    const btn = document.createElement('button');
    btn.className = 'btn';
    btn.id = 'clearLocal';
    btn.textContent = 'Clear local additions';
    container.appendChild(btn);
    btn.addEventListener('click', () => {
      localStorage.removeItem('tb_records');
      loadAndRender();
    });
  })();

  const tbody = document.getElementById('record-body');
  const count = document.getElementById('count') || (function(){
    const p = document.createElement('p');
    p.id = 'count';
    p.style.color = '#555';
    document.querySelector('main.container').appendChild(p);
    return p;
  })();

  const JSON_URL = 'records.json'; // keep next to browse.html
  const LOCAL_KEY = 'tb_records';

  let records = [];

  async function loadRepoJson() {
    try {
      const res = await fetch(`${JSON_URL}?_=${Date.now()}`, { cache: 'no-store' });
      if (!res.ok) return [];
      return await res.json();
    } catch {
      return [];
    }
  }

  function loadLocalRecords() {
    try {
      return JSON.parse(localStorage.getItem(LOCAL_KEY) || '[]');
    } catch {
      return [];
    }
  }

  function toKeyMap(obj) {
    const map = {};
    Object.keys(obj || {}).forEach(k => map[k.toLowerCase()] = obj[k]);
    return name => map[(name || '').toLowerCase()];
  }

  async function loadAndRender() {
    tbody.innerHTML = `<tr><td colspan="5">Loading…</td></tr>`;
    count.textContent = '';

    const repo = await loadRepoJson();     // from records.json
    const local = loadLocalRecords();      // from uploads (localStorage)
    records = [...repo, ...local];

    buildCategoryOptions(records);
    render();
  }

  function buildCategoryOptions(data) {
    const cats = new Set();
    data.forEach(r => {
      const g = toKeyMap(r);
      const c = (g('category') || '').toString().trim();
      if (c) cats.add(c);
    });
    filterEl.innerHTML = ['<option value="">All Categories</option>']
      .concat(Array.from(cats).sort().map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`))
      .join('');
  }

  function render() {
    const q = (search.value || '').toLowerCase().trim();
    const cat = filterEl.value;

    const filtered = records.filter(r => {
      const g = toKeyMap(r);
      const hay = `${g('title') || ''} ${g('description') || ''}`.toLowerCase();
      const inSearch = q ? hay.includes(q) : true;
      const inCat = cat ? (g('category') || '') === cat : true;
      return inSearch && inCat;
    });

    if (!filtered.length) {
      tbody.innerHTML = `<tr><td colspan="5">No records found.</td></tr>`;
      count.textContent = `0 records shown`;
      return;
    }

    tbody.innerHTML = filtered.map(r => {
      const g = toKeyMap(r);
      const title = escapeHtml(g('title') || '');
      const desc  = escapeHtml(g('description') || '');
      const date  = escapeHtml(g('date') || '');
      const cat   = escapeHtml(g('category') || '');
      const url   = (g('fileUrl') || g('file') || '').toString().trim();
      const files = Array.isArray(g('files')) ? g('files') : [];

      // Prefer a URL if present; otherwise show file names (from local uploads)
      let fileCell = '';
      if (url) {
        fileCell = `<a href="${escapeAttr(url)}" target="_blank" rel="noopener noreferrer">Open</a>`;
      } else if (files.length) {
        fileCell = escapeHtml(files.join(', '));
      }

      return `<tr>
        <td>${title}</td>
        <td>${desc}</td>
        <td>${date}</td>
        <td>${cat}</td>
        <td>${fileCell}</td>
      </tr>`;
    }).join('');

    count.textContent = `${filtered.length} record${filtered.length === 1 ? '' : 's'} shown`;
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#39;");
  }
  function escapeAttr(s) {
    return String(s).replace(/"/g, '&quot;');
  }

  // Events
  applyBtn.addEventListener('click', render);
  refreshBtn.addEventListener('click', loadAndRender);
  search.addEventListener('input', render);
  filterEl.addEventListener('change', render);

  // Go!
  loadAndRender();
</script>
</body>
</html>
